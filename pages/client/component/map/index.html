<div id="map" style="height: calc(100vh - 72px); width: 100%"></div>
<div
    id="findNearestAmbulance"
    style="
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #ef4444;
        z-index: 2147483647;
        position: fixed;
        bottom: 20px;
        right: 85px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    "
>
    <svg
        width="22"
        height="22"
        viewBox="0 0 24 24"
        fill="currentColor"
        style="transition: transform 0.2s ease"
    >
        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
    </svg>
</div>

<!-- Emergency Modal -->
<div
    id="emergencyModal"
    style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    "
>
    <div
        style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        "
    >
        <h3 style="margin-top: 0; color: #dc3545">Emergency Request</h3>

        <div style="margin: 20px 0">
            <label
                style="display: block; margin-bottom: 10px; font-weight: bold"
                >Emergency Type:</label
            >
            <select
                id="emergencyType"
                style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 14px;
                "
            >
                <option value="accident">Accident</option>
                <option value="fire">Fire</option>
                <option value="medical">Medical Emergency</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div style="margin: 20px 0">
            <label
                style="display: block; margin-bottom: 10px; font-weight: bold"
                >Number of Patients:</label
            >
            <input
                type="number"
                id="patientCount"
                min="1"
                value="1"
                style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 14px;
                    box-sizing: border-box;
                "
            />
        </div>

        <div
            style="
                font-size: 24px;
                font-weight: bold;
                color: #dc3545;
                margin: 20px 0;
            "
        >
            Auto-dispatch in: <span id="countdown">10</span>s
        </div>

        <div style="display: flex; gap: 10px; justify-content: center">
            <button
                id="confirmEmergency"
                style="
                    padding: 10px 20px;
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                "
            >
                Confirm Now
            </button>
            <button
                id="cancelEmergency"
                style="
                    padding: 10px 20px;
                    background-color: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                "
            >
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
    let countdownTimer;
    let countdownValue = 10;

    // Show emergency modal
    function showEmergencyModal() {
        document.getElementById("emergencyModal").style.display = "flex";
        countdownValue = 10;
        document.getElementById("countdown").textContent = countdownValue;

        countdownTimer = setInterval(() => {
            countdownValue--;
            document.getElementById("countdown").textContent = countdownValue;

            if (countdownValue <= 0) {
                clearInterval(countdownTimer);
                processEmergencyRequest();
            }
        }, 1000);
    }

    // Hide emergency modal
    function hideEmergencyModal() {
        document.getElementById("emergencyModal").style.display = "none";
        if (countdownTimer) {
            clearInterval(countdownTimer);
        }
    }

    // Process emergency request
    function processEmergencyRequest() {
        const emergencyType = document.getElementById("emergencyType").value;
        const patientCount = document.getElementById("patientCount").value;

        hideEmergencyModal();

        // Call the original findNearestAmbulance function
        findNearestAmbulance();

        // You can add additional logic here to handle the emergency type and patient count
        console.log("Emergency Type:", emergencyType);
        console.log("Patient Count:", patientCount);
    }

    // Event listeners
    document
        .getElementById("findNearestAmbulance")
        .addEventListener("click", function (e) {
            e.preventDefault();
            showEmergencyModal();
        });

    document
        .getElementById("confirmEmergency")
        .addEventListener("click", function () {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            processEmergencyRequest();
        });

    document
        .getElementById("cancelEmergency")
        .addEventListener("click", function () {
            hideEmergencyModal();
        });
</script>
<script>
    // Load Leaflet Routing Machine CSS
    var cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href =
        "https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css";
    document.head.appendChild(cssLink);

    // Load Leaflet Routing Machine JS
    var script = document.createElement("script");
    script.src =
        "https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js";
    document.head.appendChild(script);

    var map = L.map("map").setView([16.2467, -87.6833], 13);
    var userLocation = null;
    var ambulanceData = [];
    var ambulanceMarkers = [];
    var routingControl = null;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    // Create custom icon
    var customIcon = L.icon({
        iconUrl: "./assets/pin.png",
        iconSize: [80, 42],
        iconAnchor: [21, 42],
        popupAnchor: [0, -42],
    });

    // Create ambulance icon
    var ambulanceIcon = L.icon({
        iconUrl: "./assets/aid.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
    });

    // SIGLAT Rescue marker
    L.marker([16.2467, -87.6833], { icon: customIcon })
        .addTo(map)
        .bindPopup("SIGLAT Rescue - Villaverde, Nueva Vizcaya")
        .openPopup();

    // Function to fetch ambulance data from API
    async function fetchAmbulanceData() {
        try {
            const response = await fetch(API() + "/api/v1/Ambulance", {
                method: "GET",
                headers: {
                    accept: "*/*",
                },
            });

            if (!response.ok) {
                throw new Error("Network response was not ok");
            }

            const data = await response.json();
            ambulanceData = data;

            // Clear existing ambulance markers
            ambulanceMarkers.forEach((marker) => {
                map.removeLayer(marker);
            });
            ambulanceMarkers = [];

            // Add ambulance markers from API data
            ambulanceData.forEach(function (ambulance, index) {
                const lat = parseFloat(ambulance.latitude);
                const lng = parseFloat(ambulance.longitude);

                const marker = L.marker([lat, lng], { icon: ambulanceIcon })
                    .addTo(map)
                    .bindPopup("Ambulance Unit " + ambulance.id);

                ambulanceMarkers.push(marker);
            });
        } catch (error) {
            console.error("Error fetching ambulance data:", error);
            alert("Failed to load ambulance data from server");
        }
    }

    // Function to create route between user and ambulance
    function createRoute(userLat, userLng, ambulanceLat, ambulanceLng) {
        // Remove existing route if any
        if (routingControl) {
            map.removeControl(routingControl);
        }

        // Create new routing control
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(userLat, userLng),
                L.latLng(ambulanceLat, ambulanceLng),
            ],
            routeWhileDragging: false,
            createMarker: function () {
                return null;
            }, // Don't create default markers
            lineOptions: {
                styles: [{ color: "#dc3545", weight: 4, opacity: 0.7 }],
            },
        }).addTo(map);
    }

    // Function to find nearest ambulance using API endpoint
    async function findNearestAmbulance() {
        if (!userLocation) {
            alert("User location not available. Please allow location access.");
            return;
        }

        try {
            const response = await fetch(API() + "/api/v1/Ambulance", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    accept: "*/*",
                },
                body: JSON.stringify({
                    latitude: userLocation[0],
                    longitude: userLocation[1],
                }),
            });

            if (!response.ok) {
                throw new Error("Network response was not ok");
            }

            const nearestAmbulance = await response.json();

            if (nearestAmbulance) {
                const nearestLat = parseFloat(nearestAmbulance.latitude);
                const nearestLng = parseFloat(nearestAmbulance.longitude);

                alert(
                    "Nearest ambulance is Unit " +
                        nearestAmbulance.id +
                        (nearestAmbulance.distance
                            ? " at distance: " +
                              nearestAmbulance.distance.toFixed(2) +
                              " km"
                            : ""),
                );

                // Create route to nearest ambulance
                createRoute(
                    userLocation[0],
                    userLocation[1],
                    nearestLat,
                    nearestLng,
                );

                // Center map on nearest ambulance
                map.setView([nearestLat, nearestLng], 15);
            } else {
                alert("No ambulance found.");
            }
        } catch (error) {
            console.error("Error finding nearest ambulance:", error);
            alert("Failed to find nearest ambulance from server");
        }
    }

    // Get user's current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                var userLat = position.coords.latitude;
                var userLng = position.coords.longitude;
                userLocation = [userLat, userLng];

                // Add marker for user's location
                L.marker([userLat, userLng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup("Your Location")
                    .openPopup();

                // Center map on user's location
                map.setView([userLat, userLng], 13);
            },
            function (error) {
                console.log("Error getting location: " + error.message);
                // Keep default view if location access fails
            },
        );
    } else {
        console.log("Geolocation is not supported by this browser.");
    }

    // Fetch ambulance data on page load
    fetchAmbulanceData();
</script>
