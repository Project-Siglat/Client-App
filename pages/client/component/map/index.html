<div id="map" style="height: calc(100vh - 72px); width: 100%"></div>

<!-- Loading message -->
<div
    id="locationLoading"
    style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 1000;
        font-size: 16px;
        font-weight: bold;
    "
>
    Your location is still fetching..........
</div>

<!-- Ambulance Status Message -->
<div
    id="ambulanceStatusMessage"
    style="
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 165, 0, 0.9);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 2147483647;
        font-size: 14px;
        font-weight: bold;
        display: none;
    "
>
    Ambulance is on the way! Status: <span id="ambulanceStatus">pending</span>
</div>

<div
    id="findNearestAmbulance"
    style="
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #ef4444;
        z-index: 2147483647;
        position: fixed;
        bottom: 20px;
        right: 85px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    "
>
    <svg
        width="22"
        height="22"
        viewBox="0 0 24 24"
        fill="currentColor"
        style="transition: transform 0.2s ease"
    >
        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
    </svg>
</div>

<!-- Emergency Modal -->
<div
    id="emergencyModal"
    style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    "
>
    <div
        style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        "
    >
        <h3 style="margin-top: 0; color: #dc3545">Emergency Request</h3>

        <div style="margin: 20px 0">
            <label
                style="display: block; margin-bottom: 10px; font-weight: bold"
                >Emergency Type:</label
            >
            <select
                id="emergencyType"
                style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 14px;
                "
            >
                <option value="accident">Accident</option>
                <option value="fire">Fire</option>
                <option value="medical">Medical Emergency</option>
                <option value="other">Other</option>
            </select>
        </div>

        <div style="margin: 20px 0">
            <label
                style="display: block; margin-bottom: 10px; font-weight: bold"
                >Number of Patients:</label
            >
            <input
                type="number"
                id="patientCount"
                min="1"
                value="1"
                style="
                    width: 100%;
                    padding: 8px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 14px;
                    box-sizing: border-box;
                "
            />
        </div>

        <div
            style="
                font-size: 24px;
                font-weight: bold;
                color: #dc3545;
                margin: 20px 0;
            "
        >
            Auto-dispatch in: <span id="countdown">10</span>s
        </div>

        <div style="display: flex; gap: 10px; justify-content: center">
            <button
                id="confirmEmergency"
                style="
                    padding: 10px 20px;
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                "
            >
                Confirm Now
            </button>
            <button
                id="cancelEmergency"
                style="
                    padding: 10px 20px;
                    background-color: #6c757d;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                "
            >
                Cancel
            </button>
        </div>
    </div>
</div>

<style>
    .leaflet-routing-alternatives-container {
        display: none !important;
    }
    .leaflet-routing-container {
        display: none !important;
    }
    .leaflet-bar a,
    .leaflet-bar a:hover {
        display: none !important;
    }
</style>

<script>
    let countdownTimer;
    let countdownValue = 10;
    let currentAlertStatus = null;
    let currentAlertData = null;
    let routeCreatedForAlert = false; // Track if route was already created for current alert

    // Function to check current ambulance alert status
    async function checkCurrentAlert() {
        try {
            const authToken = sessionStorage.getItem("authToken");
            if (!authToken) {
                return null;
            }

            const response = await fetch(
                API() + "/api/v1/Ambulance/alert/current",
                {
                    method: "GET",
                    headers: {
                        accept: "*/*",
                        Authorization: `Bearer ${authToken}`,
                    },
                },
            );

            if (response.ok) {
                const alertData = await response.json();
                return alertData;
            }
            return null;
        } catch (error) {
            console.error("Error checking current alert:", error);
            return null;
        }
    }

    // Function to auto pathfind to alert coordinates
    function autoPathfindToAlert(alertData) {
        if (!alertData || !alertData.latitude || !alertData.longitude) {
            return;
        }

        if (!userLocation) {
            console.error("User location not available for pathfinding");
            return;
        }

        // Only create route and center once per alert
        if (!routeCreatedForAlert) {
            const alertLat = parseFloat(alertData.latitude);
            const alertLng = parseFloat(alertData.longitude);

            // Create route to the alert coordinates
            createRoute(userLocation[0], userLocation[1], alertLat, alertLng);

            // Center map on alert location only once
            map.setView([alertLat, alertLng], 15);

            routeCreatedForAlert = true;
        }
    }

    // Function to update UI based on alert status
    function updateUIBasedOnAlert(alertData) {
        const button = document.getElementById("findNearestAmbulance");
        const statusMessage = document.getElementById("ambulanceStatusMessage");
        const statusSpan = document.getElementById("ambulanceStatus");

        if (alertData && alertData.status === "done") {
            // Alert is done, make modal usable
            currentAlertStatus = "done";
            currentAlertData = alertData;
            routeCreatedForAlert = false; // Reset for next alert
            button.style.pointerEvents = "auto";
            button.style.opacity = "1";
            statusMessage.style.display = "none";
        } else if (alertData) {
            // Check if this is a new alert
            if (!currentAlertData || currentAlertData.id !== alertData.id) {
                routeCreatedForAlert = false; // Reset for new alert
            }

            // Alert exists (pending or any other status), disable modal, show status, and auto pathfind
            currentAlertStatus = alertData.status;
            currentAlertData = alertData;
            button.style.pointerEvents = "none";
            button.style.opacity = "0.6";

            statusMessage.style.display = "block";
            statusSpan.textContent = alertData.status;

            // Auto pathfind to the alert coordinates instead of nearest ambulance
            autoPathfindToAlert(alertData);

            // Change background color based on status
            if (alertData.status === "pending") {
                statusMessage.style.background = "rgba(255, 165, 0, 0.9)";
            } else {
                statusMessage.style.background = "rgba(0, 123, 255, 0.9)";
            }
        } else {
            // No current alert, make modal usable
            currentAlertStatus = null;
            currentAlertData = null;
            routeCreatedForAlert = false; // Reset
            button.style.pointerEvents = "auto";
            button.style.opacity = "1";
            statusMessage.style.display = "none";
        }
    }

    // Function to find nearest ambulance and get its ID
    async function findNearestAmbulanceId() {
        if (!userLocation) {
            console.error("User location not available");
            return null;
        }

        try {
            // First fetch the latest ambulance data
            await fetchAmbulanceData();

            if (ambulanceData.length === 0) {
                console.error("No ambulances available");
                return null;
            }

            let nearestAmbulance = null;
            let shortestDistance = Infinity;

            // Calculate distance to each ambulance and find the nearest one
            ambulanceData.forEach(function (ambulance) {
                const ambulanceLat = parseFloat(ambulance.latitude);
                const ambulanceLng = parseFloat(ambulance.longitude);

                const distance = calculateDistance(
                    userLocation[0],
                    userLocation[1],
                    ambulanceLat,
                    ambulanceLng,
                );

                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    nearestAmbulance = ambulance;
                }
            });

            return nearestAmbulance ? nearestAmbulance.id : null;
        } catch (error) {
            console.error("Error finding nearest ambulance:", error);
            return null;
        }
    }

    // Function to send ambulance alert
    async function sendAmbulanceAlert() {
        try {
            const emergencyType =
                document.getElementById("emergencyType").value;
            const patientCount = document.getElementById("patientCount").value;

            if (!userLocation) {
                console.error("User location not available");
                return;
            }

            // Get the nearest ambulance ID
            const nearestAmbulanceId = await findNearestAmbulanceId();
            if (!nearestAmbulanceId) {
                console.error("No ambulance available to respond");
                return;
            }

            const alertData = {
                id: "3fa85f64-5717-4562-b3fc-2c963f66afa6",
                uid: "3fa85f64-5717-4562-b3fc-2c963f66afa6",
                responder: nearestAmbulanceId,
                what: emergencyType,
                status: "pending",
                respondedAt: new Date().toISOString(),
                longitude: userLocation[1].toString(),
                latitude: userLocation[0].toString(),
            };

            const response = await fetch(API() + "/api/v1/Ambulance/alert", {
                method: "POST",
                headers: {
                    accept: "*/*",
                    Authorization: `Bearer ${sessionStorage.getItem("authToken")}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(alertData),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            console.log("Ambulance alert sent successfully");
        } catch (error) {
            console.error("Error sending ambulance alert:", error);
        }
    }

    // Show emergency modal
    function showEmergencyModal() {
        // Check if there's a current alert that would prevent showing the modal
        if (currentAlertStatus && currentAlertStatus !== "done") {
            return; // Don't show modal if ambulance is already in action
        }

        document.getElementById("emergencyModal").style.display = "flex";
        countdownValue = 10;
        document.getElementById("countdown").textContent = countdownValue;

        countdownTimer = setInterval(() => {
            countdownValue--;
            document.getElementById("countdown").textContent = countdownValue;

            if (countdownValue <= 0) {
                clearInterval(countdownTimer);
                processEmergencyRequest();
            }
        }, 1000);
    }

    // Hide emergency modal
    function hideEmergencyModal() {
        document.getElementById("emergencyModal").style.display = "none";
        if (countdownTimer) {
            clearInterval(countdownTimer);
        }
    }

    // Process emergency request
    async function processEmergencyRequest() {
        const emergencyType = document.getElementById("emergencyType").value;
        const patientCount = document.getElementById("patientCount").value;

        hideEmergencyModal();

        // Send ambulance alert
        await sendAmbulanceAlert();

        // Call the original findNearestAmbulance function
        findNearestAmbulance();

        // You can add additional logic here to handle the emergency type and patient count
        console.log("Emergency Type:", emergencyType);
        console.log("Patient Count:", patientCount);
    }

    // Event listeners
    document
        .getElementById("findNearestAmbulance")
        .addEventListener("click", function (e) {
            e.preventDefault();
            showEmergencyModal();
        });

    document
        .getElementById("confirmEmergency")
        .addEventListener("click", function () {
            if (countdownTimer) {
                clearInterval(countdownTimer);
            }
            processEmergencyRequest();
        });

    document
        .getElementById("cancelEmergency")
        .addEventListener("click", function () {
            hideEmergencyModal();
        });

    function reCenter() {
        if (userLocation) {
            map.setView([userLocation[0], userLocation[1]], 15);
        }
    }

    // Check alert status periodically
    setInterval(async () => {
        const alertData = await checkCurrentAlert();
        updateUIBasedOnAlert(alertData);
    }, 2000);
</script>
<script>
    // Load Leaflet Routing Machine CSS
    var cssLink = document.createElement("link");
    cssLink.rel = "stylesheet";
    cssLink.href =
        "https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css";
    document.head.appendChild(cssLink);

    // Load Leaflet Routing Machine JS
    var script = document.createElement("script");
    script.src =
        "https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js";
    document.head.appendChild(script);

    var map = L.map("map").setView([16.2467, -87.6833], 13);
    var userLocation = null;
    var ambulanceData = [];
    var ambulanceMarkers = [];
    var routingControl = null;
    var userLocationMarker = null;
    var locationWatchId = null;
    var isFirstLocationUpdate = true;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
    }).addTo(map);

    // Create custom icon
    var customIcon = L.icon({
        iconUrl: "./assets/pin.png",
        iconSize: [80, 42],
        iconAnchor: [21, 42],
        popupAnchor: [0, -42],
    });

    // Create ambulance icon
    var ambulanceIcon = L.icon({
        iconUrl: "./assets/aid.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
    });

    // SIGLAT Rescue marker
    L.marker([16.2467, -87.6833], { icon: customIcon })
        .addTo(map)
        .bindPopup("SIGLAT Rescue - Villaverde, Nueva Vizcaya")
        .openPopup();

    // Function to calculate distance between two points using Haversine formula
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in kilometers
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((lat1 * Math.PI) / 180) *
                Math.cos((lat2 * Math.PI) / 180) *
                Math.sin(dLon / 2) *
                Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = R * c; // Distance in kilometers
        return distance;
    }

    // Function to post user coordinates to API
    async function postUserCoordinates(latitude, longitude) {
        try {
            const authToken = sessionStorage.getItem("authToken");
            if (!authToken) {
                console.log("No auth token found in session storage");
                return;
            }

            // You'll need to replace this with the actual user ID
            // For now using a placeholder - you should get this from your user session/storage
            const userId = "3fa85f64-5717-4562-b3fc-2c963f66afa6";

            const response = await fetch(API() + "/api/v1/User/coordinates", {
                method: "POST",
                headers: {
                    accept: "*/*",
                    Authorization: `Bearer ${authToken}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    id: userId,
                    latitude: latitude.toString(),
                    longitude: longitude.toString(),
                }),
            });

            if (!response.ok) {
                console.error("Failed to post coordinates:", response.status);
            }
        } catch (error) {
            console.error("Error posting coordinates:", error);
        }
    }

    // Function to fetch ambulance data from API
    async function fetchAmbulanceData() {
        try {
            const response = await fetch(API() + "/api/v1/Ambulance", {
                method: "GET",
                headers: {
                    accept: "*/*",
                },
            });

            if (!response.ok) {
                throw new Error("Network response was not ok");
            }

            const data = await response.json();
            ambulanceData = data;

            // Clear existing ambulance markers
            ambulanceMarkers.forEach((marker) => {
                map.removeLayer(marker);
            });
            ambulanceMarkers = [];

            // Add ambulance markers from API data
            ambulanceData.forEach(function (ambulance, index) {
                const lat = parseFloat(ambulance.latitude);
                const lng = parseFloat(ambulance.longitude);

                const marker = L.marker([lat, lng], { icon: ambulanceIcon })
                    .addTo(map)
                    .bindPopup("Ambulance Unit " + ambulance.id);

                ambulanceMarkers.push(marker);
            });
        } catch (error) {
            console.error("Error fetching ambulance data:", error);
            alert("Failed to load ambulance data from server");
        }
    }

    // Function to create route between user and ambulance
    function createRoute(userLat, userLng, ambulanceLat, ambulanceLng) {
        // Remove existing route if any
        if (routingControl) {
            map.removeControl(routingControl);
        }

        // Create new routing control
        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(userLat, userLng),
                L.latLng(ambulanceLat, ambulanceLng),
            ],
            routeWhileDragging: false,
            createMarker: function () {
                return null;
            }, // Don't create default markers
            lineOptions: {
                styles: [{ color: "#dc3545", weight: 4, opacity: 0.7 }],
            },
            show: false,
            addWaypoints: false,
            fitSelectedRoutes: false,
            collapsible: false,
        }).addTo(map);

        // Force hide the routing alternatives container after it's added
        setTimeout(() => {
            const routingContainers = document.querySelectorAll(
                ".leaflet-routing-alternatives-container, .leaflet-routing-container",
            );
            routingContainers.forEach((container) => {
                container.style.display = "none !important";
                container.style.visibility = "hidden";
                container.style.opacity = "0";
                container.remove();
            });
        }, 100);
    }

    // Function to update user location
    function updateUserLocation(position) {
        var userLat = position.coords.latitude;
        var userLng = position.coords.longitude;
        userLocation = [userLat, userLng];

        // Hide loading message
        document.getElementById("locationLoading").style.display = "none";

        // Remove existing user location marker if it exists
        if (userLocationMarker) {
            map.removeLayer(userLocationMarker);
        }

        // Add new marker for user's location
        userLocationMarker = L.marker([userLat, userLng], { icon: customIcon })
            .addTo(map)
            .bindPopup("Your Location");

        // Only center map on first load or when no ambulance is active
        if (
            isFirstLocationUpdate &&
            (!currentAlertStatus || currentAlertStatus === "done")
        ) {
            map.setView([userLat, userLng], 13);
            isFirstLocationUpdate = false;
        }

        // Post coordinates to API
        postUserCoordinates(userLat, userLng);
    }

    // Function to find nearest ambulance using client-side calculation
    async function findNearestAmbulance() {
        if (!userLocation) {
            alert("User location not available. Please allow location access.");
            return;
        }

        try {
            // First fetch the latest ambulance data
            await fetchAmbulanceData();

            if (ambulanceData.length === 0) {
                alert("No ambulances available.");
                return;
            }

            let nearestAmbulance = null;
            let shortestDistance = Infinity;

            // Calculate distance to each ambulance and find the nearest one
            ambulanceData.forEach(function (ambulance) {
                const ambulanceLat = parseFloat(ambulance.latitude);
                const ambulanceLng = parseFloat(ambulance.longitude);

                const distance = calculateDistance(
                    userLocation[0],
                    userLocation[1],
                    ambulanceLat,
                    ambulanceLng,
                );

                if (distance < shortestDistance) {
                    shortestDistance = distance;
                    nearestAmbulance = {
                        ...ambulance,
                        distance: distance,
                    };
                }
            });

            if (nearestAmbulance) {
                const nearestLat = parseFloat(nearestAmbulance.latitude);
                const nearestLng = parseFloat(nearestAmbulance.longitude);

                alert(
                    "Nearest ambulance is Unit " +
                        nearestAmbulance.id +
                        " at distance: " +
                        nearestAmbulance.distance.toFixed(2) +
                        " km",
                );

                // Create route to nearest ambulance
                createRoute(
                    userLocation[0],
                    userLocation[1],
                    nearestLat,
                    nearestLng,
                );

                // Center map on nearest ambulance
                map.setView([nearestLat, nearestLng], 15);
            } else {
                alert("No ambulance found.");
            }
        } catch (error) {
            console.error("Error finding nearest ambulance:", error);
            alert("Failed to find nearest ambulance");
        }
    }

    // Get user's current location and set up continuous tracking
    if (navigator.geolocation) {
        // Get initial position
        navigator.geolocation.getCurrentPosition(
            updateUserLocation,
            function (error) {
                console.log("Error getting location: " + error.message);
                // Hide loading message even on error
                document.getElementById("locationLoading").style.display =
                    "none";
                // Keep default view if location access fails
            },
        );

        // Set up continuous location tracking every 0.5 seconds
        setInterval(() => {
            navigator.geolocation.getCurrentPosition(
                updateUserLocation,
                function (error) {
                    console.log("Error updating location: " + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0,
                },
            );
        }, 500);
    } else {
        console.log("Geolocation is not supported by this browser.");
        // Hide loading message if geolocation is not supported
        document.getElementById("locationLoading").style.display = "none";
    }

    // Fetch ambulance data on page load
    fetchAmbulanceData();

    // Set up continuous ambulance data fetching every 0.5 seconds
    setInterval(() => {
        fetchAmbulanceData();
    }, 500);
</script>
