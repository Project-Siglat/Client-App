<div
    id="chatButton"
    class="button-animate"
    style="
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #10b981;
        z-index: 2147483647;
        position: fixed;
        bottom: 20px;
        right: 155px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    "
    onclick="handleChat()"
>
    <svg
        width="22"
        height="22"
        viewBox="0 0 24 24"
        fill="currentColor"
        style="transition: transform 0.2s ease"
    >
        <path
            d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
        />
    </svg>
</div>
<div
    id="chatDrawer"
    style="
        position: fixed;
        bottom: -80vh;
        right: 4px;
        left: 4px;
        width: calc(100vw - 8px);
        height: 80vh;
        background: #282828;
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        z-index: 2147483647;
        transition: bottom 0.3s ease;
        display: flex;
        flex-direction: column;
        font-family:
            -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto,
            sans-serif;
    "
>
    <!-- Conversation List View -->
    <div
        id="conversationList"
        style="display: flex; flex-direction: column; height: 100%"
    >
        <div
            id="chatListHeader"
            style="
                background: #665c54;
                color: #ebdbb2;
                padding: 16px 20px;
                border-radius: 12px 12px 0 0;
                cursor: grab;
                display: flex;
                justify-content: space-between;
                align-items: center;
                user-select: none;
                min-height: 48px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            "
        >
            <span
                id="chatHeaderTitle"
                style="font-weight: 600; font-size: clamp(16px, 4vw, 18px)"
            ></span>
            <button
                onclick="closeChat()"
                style="
                    background: rgba(235, 219, 178, 0.2);
                    border: none;
                    color: #ebdbb2;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 8px;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 6px;
                    transition: background-color 0.2s ease;
                "
                onmouseover="this.style.backgroundColor='rgba(235, 219, 178, 0.3)'"
                onmouseout="this.style.backgroundColor='rgba(235, 219, 178, 0.2)'"
            >
                ×
            </button>
        </div>

        <div style="flex: 1; overflow-y: auto; background: #282828">
            <div id="conversationListItems" style="padding: 0">
                <!-- Conversation items will be dynamically generated here -->
            </div>
        </div>
    </div>

    <!-- Individual Conversation View -->
    <div
        id="conversationView"
        style="display: none; flex-direction: column; height: 100%"
    >
        <div
            id="chatHeader"
            style="
                background: #665c54;
                color: #ebdbb2;
                padding: 16px 20px;
                border-radius: 12px 12px 0 0;
                cursor: grab;
                display: flex;
                justify-content: space-between;
                align-items: center;
                user-select: none;
                min-height: 48px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            "
        >
            <div
                style="
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    flex: 1;
                    min-width: 0;
                "
            >
                <button
                    onclick="showConversationList()"
                    style="
                        background: rgba(235, 219, 178, 0.2);
                        border: none;
                        color: #ebdbb2;
                        font-size: 18px;
                        cursor: pointer;
                        padding: 8px;
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 6px;
                        flex-shrink: 0;
                        transition: background-color 0.2s ease;
                    "
                    onmouseover="this.style.backgroundColor='rgba(235, 219, 178, 0.3)'"
                    onmouseout="this.style.backgroundColor='rgba(235, 219, 178, 0.2)'"
                >
                    ←
                </button>
                <div
                    style="
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        min-width: 0;
                    "
                >
                    <div
                        id="currentContactAvatar"
                        style="
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            background: rgba(235, 219, 178, 0.2);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 600;
                            font-size: 14px;
                            flex-shrink: 0;
                        "
                    ></div>
                    <span
                        id="currentContactName"
                        style="
                            font-weight: 600;
                            font-size: clamp(14px, 4vw, 16px);
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                        "
                    ></span>
                </div>
            </div>
            <button
                onclick="closeChat()"
                style="
                    background: rgba(235, 219, 178, 0.2);
                    border: none;
                    color: #ebdbb2;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 8px;
                    width: 32px;
                    height: 32px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 6px;
                    flex-shrink: 0;
                    transition: background-color 0.2s ease;
                "
                onmouseover="this.style.backgroundColor='rgba(235, 219, 178, 0.3)'"
                onmouseout="this.style.backgroundColor='rgba(235, 219, 178, 0.2)'"
            >
                ×
            </button>
        </div>

        <div
            id="chatMessages"
            style="
                flex: 1;
                padding: 16px;
                overflow-y: auto;
                background: #1d2021;
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            "
        >
            <!-- Messages will be dynamically loaded here -->
        </div>

        <div
            style="
                padding: 16px;
                border-top: 1px solid #3c3836;
                background: #282828;
                display: flex;
                gap: 12px;
                align-items: flex-end;
            "
        >
            <input
                type="text"
                id="chatInput"
                placeholder="Type a message..."
                style="
                    flex: 1;
                    padding: 12px 16px;
                    border: 1px solid #3c3836;
                    border-radius: 24px;
                    outline: none;
                    font-size: 16px;
                    background: #3c3836;
                    color: #ebdbb2;
                    min-height: 20px;
                    resize: none;
                    transition: border-color 0.2s ease;
                "
                onfocus="this.style.borderColor='#b16286'"
                onblur="this.style.borderColor='#3c3836'"
            />
            <button
                onclick="sendMessage()"
                style="
                    background: #b16286;
                    color: #ebdbb2;
                    border: none;
                    border-radius: 50%;
                    width: 44px;
                    height: 44px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                    transition: background-color 0.2s ease;
                    box-shadow: 0 2px 4px rgba(177, 98, 134, 0.3);
                "
                onmouseover="this.style.backgroundColor='#8f3f71'"
                onmouseout="this.style.backgroundColor='#b16286'"
            >
                <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                >
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    let isDragging = false;
    let dragStartY = 0;
    let drawerStartBottom = 0;
    let isOpen = false;
    let currentConversation = "andrew";
    let currentView = "list"; // "list" or "conversation"

    const conversations = {
        andrew: {
            name: "Andrew",
            lastMessage:
                "Of course! I'd be happy to help you with your order. Can you provide me with your order number?",
            lastTime: "10:33 AM",
            unread: 0,
            messages: [
                {
                    type: "received",
                    message: "Hey there! How can I help you today?",
                    time: "10:30 AM",
                },
                {
                    type: "sent",
                    message: "Hi! I'm looking for some help with my order.",
                    time: "10:32 AM",
                },
                {
                    type: "received",
                    message:
                        "Of course! I'd be happy to help you with your order. Can you provide me with your order number?",
                    time: "10:33 AM",
                },
            ],
        },
        mike: {
            name: "Mike",
            lastMessage: "Hello Mike! I need help with technical support.",
            lastTime: "09:16 AM",
            unread: 2,
            messages: [
                {
                    type: "received",
                    message: "Hi! Mike here, what can I do for you?",
                    time: "09:15 AM",
                },
                {
                    type: "sent",
                    message: "Hello Mike! I need help with technical support.",
                    time: "09:16 AM",
                },
            ],
        },
        sarah: {
            name: "Sarah",
            lastMessage:
                "Hello! Sarah from customer service. How may I assist you?",
            lastTime: "11:20 AM",
            unread: 1,
            messages: [
                {
                    type: "received",
                    message:
                        "Hello! Sarah from customer service. How may I assist you?",
                    time: "11:20 AM",
                },
            ],
        },
        jessica: {
            name: "Jessica",
            lastMessage:
                "Perfect! I can definitely help with billing. What specific questions do you have?",
            lastTime: "02:47 PM",
            unread: 0,
            messages: [
                {
                    type: "received",
                    message:
                        "Hey! Jessica here. Ready to help with any questions!",
                    time: "02:45 PM",
                },
                {
                    type: "sent",
                    message: "Great! I have some billing questions.",
                    time: "02:46 PM",
                },
                {
                    type: "received",
                    message:
                        "Perfect! I can definitely help with billing. What specific questions do you have?",
                    time: "02:47 PM",
                },
            ],
        },
    };

    function updateChatHeaderTitle() {
        const userRole = sessionStorage.getItem("userRole") || "Messages";
        const titleElement = document.getElementById("chatHeaderTitle");
        if (titleElement) {
            titleElement.textContent = userRole;
        }
    }

    function showConversationList() {
        document.getElementById("conversationList").style.display = "flex";
        document.getElementById("conversationView").style.display = "none";
        currentView = "list";
        updateChatHeaderTitle();
        loadConversationList();
    }

    function showConversation(conversationId) {
        currentConversation = conversationId;
        currentView = "conversation";

        // Update header with contact info
        const contact = conversations[conversationId];
        document.getElementById("currentContactName").textContent =
            contact.name;
        document.getElementById("currentContactAvatar").textContent =
            contact.name[0].toUpperCase();

        // Mark as read
        conversations[conversationId].unread = 0;

        document.getElementById("conversationList").style.display = "none";
        document.getElementById("conversationView").style.display = "flex";

        loadConversation();
    }

    function loadConversationList() {
        const listContainer = document.getElementById("conversationListItems");
        listContainer.innerHTML = "";

        Object.keys(conversations).forEach((key) => {
            const convo = conversations[key];
            const listItem = document.createElement("div");
            listItem.style.cssText = `
                padding: 16px 20px;
                border-bottom: 1px solid #3c3836;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: background-color 0.2s ease;
                background: #282828;
            `;

            listItem.addEventListener("mouseenter", () => {
                listItem.style.backgroundColor = "#3c3836";
            });

            listItem.addEventListener("mouseleave", () => {
                listItem.style.backgroundColor = "#282828";
            });

            listItem.onclick = () => showConversation(key);

            const unreadBadge =
                convo.unread > 0
                    ? `<div style="
                    background: #b16286;
                    color: #ebdbb2;
                    border-radius: 50%;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    font-weight: 600;
                    margin-left: auto;
                    box-shadow: 0 2px 4px rgba(177, 98, 134, 0.3);
                ">${convo.unread}</div>`
                    : "";

            listItem.innerHTML = `
                <div style="
                    width: 48px;
                    height: 48px;
                    border-radius: 50%;
                    background: #b16286;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #ebdbb2;
                    font-weight: 600;
                    font-size: 18px;
                    box-shadow: 0 2px 4px rgba(177, 98, 134, 0.3);
                ">${convo.name[0].toUpperCase()}</div>

                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-weight: 600; color: #ebdbb2; font-size: 16px;">${convo.name}</span>
                        <small style="color: #a89984; font-size: 12px;">${convo.lastTime}</small>
                    </div>
                    <div style="
                        color: #a89984;
                        font-size: 14px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        max-width: 280px;
                        line-height: 1.4;
                    ">${convo.lastMessage}</div>
                </div>

                ${unreadBadge}
            `;

            listContainer.appendChild(listItem);
        });
    }

    function switchConversation() {
        const select = document.getElementById("conversationSelect");
        currentConversation = select.value;
        loadConversation();
    }

    function loadConversation() {
        const messagesContainer = document.getElementById("chatMessages");
        messagesContainer.innerHTML = "";

        const messages = conversations[currentConversation].messages;
        messages.forEach((msg) => {
            const messageDiv = document.createElement("div");
            if (msg.type === "received") {
                messageDiv.style.cssText = "margin-bottom: 16px;";
                messageDiv.innerHTML = `
                    <div style="
                        background: #3c3836;
                        padding: 12px 16px;
                        border-radius: 18px;
                        max-width: 70%;
                        margin-bottom: 4px;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
                        border: 1px solid #504945;
                        color: #ebdbb2;
                        line-height: 1.4;
                    ">
                        ${msg.message}
                    </div>
                    <small style="color: #a89984; font-size: 12px; margin-left: 4px;">${msg.time}</small>
                `;
            } else {
                messageDiv.style.cssText =
                    "margin-bottom: 16px; text-align: right;";
                messageDiv.innerHTML = `
                    <div style="
                        background: #b16286;
                        color: #ebdbb2;
                        padding: 12px 16px;
                        border-radius: 18px;
                        max-width: 70%;
                        margin-left: auto;
                        margin-bottom: 4px;
                        box-shadow: 0 2px 4px rgba(177, 98, 134, 0.3);
                        line-height: 1.4;
                    ">
                        ${msg.message}
                    </div>
                    <small style="color: #a89984; font-size: 12px; margin-right: 4px;">${msg.time}</small>
                `;
            }
            messagesContainer.appendChild(messageDiv);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function handleChat() {
        // Add click animation
        const button = document.getElementById("chatButton");
        button.style.animation = "buttonPulse 0.3s ease";
        setTimeout(() => (button.style.animation = ""), 300);

        toggleChat();
    }

    function toggleChat() {
        const drawer = document.getElementById("chatDrawer");
        isOpen = !isOpen;

        if (isOpen) {
            drawer.style.bottom = "0";
            if (currentView === "list") {
                showConversationList();
            } else {
                showConversation(currentConversation);
            }
        } else {
            drawer.style.bottom = "-80vh";
        }
    }

    function closeChat() {
        const drawer = document.getElementById("chatDrawer");
        drawer.style.bottom = "-80vh";
        isOpen = false;
    }

    function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
            });

            // Add to conversation data
            conversations[currentConversation].messages.push({
                type: "sent",
                message: message,
                time: timeString,
            });

            // Update last message info
            conversations[currentConversation].lastMessage = message;
            conversations[currentConversation].lastTime = timeString;

            // Reload conversation to show new message
            loadConversation();
            input.value = "";
        }
    }

    // Make drawer draggable
    let chatHeader, chatDrawer;

    function initializeDragHandlers() {
        chatHeader =
            document.getElementById("chatListHeader") ||
            document.getElementById("chatHeader");
        chatDrawer = document.getElementById("chatDrawer");

        if (chatHeader) {
            chatHeader.addEventListener("mousedown", startDrag);
        }
    }

    document.addEventListener("mousemove", drag);
    document.addEventListener("mouseup", stopDrag);

    function startDrag(e) {
        isDragging = true;
        dragStartY = e.clientY;
        drawerStartBottom = parseInt(chatDrawer.style.bottom) || 0;
        if (chatHeader) chatHeader.style.cursor = "grabbing";
    }

    function drag(e) {
        if (!isDragging) return;

        const deltaY = (dragStartY - e.clientY) * 2; // Made drag more sensitive by multiplying by 2
        const newBottom = drawerStartBottom + deltaY;

        // Constrain movement
        const maxBottom = 0;
        const minBottom = -window.innerHeight * 0.8;

        const constrainedBottom = Math.max(
            minBottom,
            Math.min(maxBottom, newBottom),
        );
        chatDrawer.style.bottom = constrainedBottom + "px";
    }

    function stopDrag() {
        if (!isDragging) return;

        isDragging = false;
        if (chatHeader) chatHeader.style.cursor = "grab";

        const currentBottom = parseInt(chatDrawer.style.bottom);
        const threshold = -window.innerHeight * 0.15; // Made threshold smaller for more sensitive closing

        if (currentBottom < threshold) {
            closeChat();
        } else {
            chatDrawer.style.bottom = "0";
            isOpen = true;
        }
    }

    // Initialize drag handlers when DOM is ready
    setTimeout(initializeDragHandlers, 100);

    // Allow Enter key to send message
    document.addEventListener("DOMContentLoaded", function () {
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
            chatInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    sendMessage();
                }
            });
        }
    });

    // Re-initialize drag handlers when view changes
    function updateDragHandlers() {
        setTimeout(initializeDragHandlers, 50);
    }

    // Override show functions to update drag handlers
    const originalShowConversationList = showConversationList;
    const originalShowConversation = showConversation;

    showConversationList = function () {
        originalShowConversationList();
        updateDragHandlers();
    };

    showConversation = function (conversationId) {
        originalShowConversation(conversationId);
        updateDragHandlers();
    };
</script>
